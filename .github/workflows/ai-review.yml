name: AI Reviewer

on:
  push:
    branches:
      - "draft/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install anthropic

      # ğŸ‘‡ ã€å¤‰æ›´ç‚¹ã€‘ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã‚ãšã€Gitã‚³ãƒãƒ³ãƒ‰ã§ç›´æ¥å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¾ã™
      - name: Run AI Reviewer
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆ(HEAD^)ã¨ç¾åœ¨(HEAD)ã®å·®åˆ†ã‚’è¦‹ã¦ã€.mdãƒ•ã‚¡ã‚¤ãƒ«ã ã‘æŠ½å‡º
          # æ–°è¦ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯origin/mainã¨ã®å·®åˆ†ã‚’è¦‹ã‚‹ãªã©èª¿æ•´ãŒå¿…è¦ã§ã™ãŒ
          # ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œå¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚’æ¢ã—ã¾ã™

          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '\.md$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No markdown files changed."
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
            exit 0
          fi

          echo "Found markdown files: $CHANGED_FILES"
          echo "HAS_CHANGES=true" >> $GITHUB_ENV

          # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ¸¡ã—ã¦å®Ÿè¡Œ
          python ai_reviewer.py $CHANGED_FILES

      # ğŸ‘‡ ã€å¤‰æ›´ç‚¹ã€‘PythonãŒå®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã¿PRä½œæˆã«é€²ã‚€
      - name: Create Pull Request
        if: env.HAS_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤‰æ›´ãŒã‚ã‚‹ã‹å¿µã®ãŸã‚Gitãƒ¬ãƒ™ãƒ«ã§ã‚‚ç¢ºèª
          if git diff --quiet; then
            echo "No changes made by AI."
            exit 0
          fi

          BRANCH_NAME="ai-review/${{ github.ref_name }}-$(date +%s)"
          git config --global user.name "Claude-Reviewer"
          git config --global user.email "claude@example.com"

          git checkout -b $BRANCH_NAME
          git add .
          git commit -m "refactor: AIã«ã‚ˆã‚‹è¨˜äº‹æ ¡æ­£"
          git push origin $BRANCH_NAME

          gh pr create \
            --base ${{ github.ref_name }} \
            --head $BRANCH_NAME \
            --title "ğŸ¤– AI Review: ${{ github.ref_name }} ã®æ ¡æ­£ææ¡ˆ" \
            --body "Claude 3.5 Sonnetã«ã‚ˆã‚‹è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã§ã™ã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãƒãƒ¼ã‚¸ã€ã¾ãŸã¯ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
