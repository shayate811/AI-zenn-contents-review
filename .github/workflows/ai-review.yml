name: AI Architect Reviewer

on:
  push:
    branches:
      - "draft/**" # draft/ ã‹ã‚‰å§‹ã¾ã‚‹ãƒ–ãƒ©ãƒ³ãƒã¸ã®Pushã§ç™ºç«

permissions:
  contents: write
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install anthropic

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            articles/*.md
            docs/*.md

      - name: Run AI Reviewer
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python ai_reviewer.py ${{ steps.changed-files.outputs.all_changed_files }}

      - name: Create Pull Request
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          if git diff --quiet; then
            echo "No changes made by AI."
            exit 0
          fi

          # AIç”¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          BRANCH_NAME="ai-review/${{ github.ref_name }}-$(date +%s)"
          git config --global user.name "Claude-Reviewer"
          git config --global user.email "claude@example.com"

          git checkout -b $BRANCH_NAME
          git add .
          git commit -m "refactor: AIã«ã‚ˆã‚‹è¨˜äº‹æ ¡æ­£"
          git push origin $BRANCH_NAME

          # PRã‚’ä½œæˆ
          gh pr create \
            --base ${{ github.ref_name }} \
            --head $BRANCH_NAME \
            --title "ğŸ¤– AI Review: ${{ github.ref_name }} ã®æ ¡æ­£ææ¡ˆ" \
            --body "Claude 3.5 Sonnetã«ã‚ˆã‚‹è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã§ã™ã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãƒãƒ¼ã‚¸ã€ã¾ãŸã¯ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
